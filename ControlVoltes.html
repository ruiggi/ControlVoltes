<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Vueltas</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#333">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEyIDdWMTJIMTdNMjEgMTJDMjEgMTYuOTcwNiAxNi45NzA2IDIxIDEyIDIxQzcuMDI5NDQgMjEgMyAxNi45NzA2IDMgMTJDMyA3LjAyOTQ0IDcuMDI5NDQgMyAxMiAzQzE2Ljk3MDYgMyAyMSA3LjAyOTQ0IDIxIDEyWiIgc3Ryb2tlPSIjZjBmMGYwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvc3ZnPg==">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IiNmMGYwZjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEyIDdWMTJIMTdNMjEgMTJDMjEgMTYuOTcwNiAxNi45NzA2IDIxIDEyIDIxQzcuMDI5NDQgMjEgMyAxNi45NzA2IDMgMTJDMyA3LjAyOTQ0IDcuMDI5NDQgMyAxMiAzQzE2Ljk3MDYgMyAyMSA3LjAyOTQ0IDIxIDEyWiIgc3Ryb2tlPSIjZjBmMGYwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvc3ZnPg==">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
        }
        #main-container {
            width: 100%;
            max-width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
		
		:root {
    --bg-color: #1a1a1a;
    --primary-color: #f0f0f0;
    --secondary-color: #a0a0a0;
    --accent-color: #00aaff;
    --work-color: #28a745;
    --rest-color: #ffc107;
    --danger-color: #dc3545;
    --card-bg-color: #2c2c2c;
    }

    body {
        font-family: "Arial Narrow", Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--primary-color);
        margin: 0;
        padding: 5px;
        overscroll-behavior: none;
    }

    /* Asegura que los controles de formulario usen la misma tipografía */
    button,
    input,
    select,
    textarea {
        font-family: inherit;
    }

    /* Accesibilidad: enfoque visible para controles interactivos */
    button:focus-visible,
    .lap-type-toggle:focus-visible,
    .control-btn:focus-visible,
    .session-item button:focus-visible,
    .delete-btn:focus-visible,
    #toggle-view-btn:focus-visible,
    #clock-container:focus-visible {
        outline: 2px solid var(--accent-color);
        outline-offset: 2px;
    }

    #main-container {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 500px;
        margin: 0;
        width: 100%;
        box-sizing: border-box;
    }

    #registration-view,
    #sessions-view {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 3px;
        padding-top: 1px; /* Reduced from 60px to minimize space below title */
    }

    #app-title {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 700;
        letter-spacing: 0.02em;
        opacity: 1;
        font-size: 1.1rem;
        color: black;
        background-color: white;
        padding: 8px 20px; /* Similar to session-top-bar padding */
        z-index: 100;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #toggle-view-btn {
        position: absolute;
        top: -10px;
        right: 20px;
        cursor: pointer;
        z-index: 101; /* Higher than title to appear on top */
    }

    #clock-container {
        width: 100%;
        padding: 5px !important;
        background-color: #2E7D32; /* Verde oscuro por defecto */
        border-radius: 5px;
        cursor: pointer;
        user-select: none;
        -webkit-tap-highlight-color: transparent; /* Evita el destello azul en móviles */
        transition: background-color 0.2s;
        border: 1px solid #3a3a3a;
    }

    #clock-container:active {
        background-color: #444;
    }

    #clock {
        font-family: Arial Black, sans-serif;
        font-size: 5rem;
        font-weight: 600;
        text-align: center;
        letter-spacing: 2px;
    }

    .clock-subtitle {
        text-align: center;
        color: var(--secondary-color);
        font-size: 0.8rem;
        margin-top: 5px;
    }

    #summary-container {
        display: flex;
        justify-content: space-between;
        width: 100%;
        background-color: #242a2f;
        padding: 5px !important;
        border-radius: 15px;
        border: 1px solid #3a3a3a;
        gap: 5px;
    }

    .summary-item {
        text-align: center;
        flex: 1 1 0;
        min-width: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 3px; /* gaps más pequeños dentro de cada item */
        padding: 3px 3px; /* compacto dentro del item */
        border: 1px solid #3a3a3a; /* borde para resaltar cada item */
        border-radius: 10px;
    }

    .summary-item span {
        font-size: 1.05rem; /* labels más grandes */
        color: var(--secondary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    /* Igualar tamaño de iconos al texto del label */
    .summary-item span svg {
        width: 1.2em;  /* iconos más grandes */
        height: 1.2em;
        flex-shrink: 0;
    }

    .summary-item strong {
        font-size: clamp(1.2rem, 5vw, 1.8rem); /* valor más grande */
        font-weight: 600; /* un poco más grueso */
        white-space: nowrap; /* Mantiene SS.ms en una sola línea */
        display: flex;
        align-items: center;
        justify-content: center; /* Centra vertical y horizontalmente el valor */
        line-height: 1; /* Evita que el superíndice desplace el bloque */
    }

    #laps-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 5px !important;
    }

    .lap-item {
        display: flex;
        align-items: center;
        gap: 3px;
        padding: 3px 3px;
        background-color: var(--card-bg-color);
        border-radius: 10px;
        border: 1px solid #3a3a3a;
        border-left: 5px solid var(--secondary-color);
        margin: 0 2px;
    }

    .lap-index {
        font-weight: 600;
        color: var(--secondary-color);
        min-width: 1.5em;
        text-align: right;
    }

    .lap-item.work {
        border-left-color: var(--work-color);
    }

    .lap-item.rest {
        border-left-color: var(--rest-color);
    }

    .lap-time {
        font-size: clamp(0.95rem, 3.8vw, 1.2rem);
        font-weight: 500;
        white-space: nowrap;
        flex: 0 0 auto;
    }

    .lap-duration {
        font-size: clamp(0.85rem, 3.2vw, 1rem);
        color: var(--secondary-color);
        white-space: nowrap;
        flex: 0 0 auto;
    }

    .lap-name {
        flex: 1 1 auto;
        min-width: 0;
        font-size: clamp(0.9rem, 3.5vw, 1.1rem);
        border: none;
        background: none;
        color: var(--primary-color);
        padding: 3px 3px;
        border-radius: 3px;
        width: 100%;
    }

    .lap-name::placeholder {
        color: var(--secondary-color);
    }

    .lap-name:focus {
        outline: none;
        background-color: #444;
    }

    .delete-btn {
        border: none;
        background: none;
        color: var(--secondary-color);
        cursor: pointer;
        font-size: 1.5rem;
        padding: 0 5px;
        line-height: 1;
        flex: 0 0 auto;
    }

    .delete-btn:hover {
        color: var(--danger-color);
    }

    .lap-type-toggle {
        padding: 3px 3px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        border: 1px solid var(--secondary-color);
        background-color: transparent;
        color: var(--secondary-color);
        transition: all 0.2s;
        white-space: nowrap;
        flex: 0 0 auto;
        min-width: auto;
        display: flex;
        justify-content: center;
        box-sizing: border-box;
        margin: 0 4px;
        text-transform: uppercase;
    }

    .lap-type-toggle.work {
        border-color: var(--work-color);
        background-color: var(--work-color);
        color: #fff;
    }

    .lap-type-toggle.rest {
        border-color: var(--rest-color);
        background-color: var(--rest-color);
        color: #333;
    }

    #controls-container {
        width: 100%;
        height: 30px;
    }

    .control-btn {
        width: 100%;
        padding: 5px;
        font-size: 1.2rem;
        font-weight: 500;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        background-color: var(--accent-color);
        color: #fff;
        transition: background-color 0.2s;
    }

    .control-btn:hover {
        background-color: #0088cc;
    }

    #sessions-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    /* Disposición más compacta en pantallas muy estrechas */
    @media (max-width: 360px) {
        .lap-item {
            flex-direction: column;
            align-items: stretch;
            gap: 5px;
            padding: 3px 3px;
            margin: 0 1px;
        }
        .lap-time,
        .lap-duration,
        .lap-type-toggle,
        .delete-btn {
            align-self: flex-start;
        }
    }

    /* Media queries adicionales para móviles */
    @media (max-width: 480px) {
        body {
            padding: 2px;
        }
        #main-container {
            padding: 2px;
            max-width: none;
        }
        #toggle-view-btn {
            top: 10px;
            right: 10px;
        }
        .session-top-bar {
            padding: 8px;
            font-size: 0.9em;
        }
        .session-top-bar button {
            padding: 6px 10px;
            font-size: 0.8em;
        }
        #session-info {
            padding: 15px;
        }
        #session-name-row {
            margin: 8px 0 15px 0;
        }
        #session-name-row .nameLabel {
            font-size: 1.1em;
        }
    }

    .session-item {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px;
        background-color: var(--card-bg-color);
        border-radius: 10px;
        border: 1px solid #3a3a3a;
    }

    .session-item > span {
        flex-grow: 1;
        font-size: 1.1rem;
    }

    .session-item button {
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        border: 1px solid var(--secondary-color);
        background-color: transparent;
        color: var(--secondary-color);
        transition: all 0.2s;
    }

    .session-item button:hover {
        background-color: var(--secondary-color);
        color: var(--bg-color);
    }

    /* Metadatos de sesión: fila debajo del nombre de archivo */
    .session-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 4px;
    }

    .session-meta .meta {
        background-color: rgba(255,255,255,0.08);
        border: 1px solid #3a3a3a;
        border-radius: 6px;
        padding: 2px 6px;
        font-size: 0.9rem;
        color: var(--secondary-color);
    }
    #sessions-container h2 {
    font-size: 1.3rem;
    margin-bottom: 10px;
    margin-top: 35px;
    color: var(--primary-color);
}    
    </style>
</head>
<body>
    <div id="main-container" style="position: relative;">
        <div id="toggle-view-btn"></div>
        <div id="app-title">CONTROL DE VOLTES</div>
        <div id="registration-view" style="display: block;">
            <div id="date-container" style="text-align: center; color: var(--secondary-color); margin-bottom: 10px;"></div>
            <div id="clock-container">
                <div id="clock" aria-live="polite" aria-atomic="true">00:00:00.000</div>
            </div>
            <div id="summary-container">
                <div class="summary-item">
                    <span>Trabajo</span>
                    <strong id="total-work" aria-live="polite" aria-atomic="true">0:00:00.000</strong>
                </div>
                <div class="summary-item">
                    <span>Reposo</span>
                    <strong id="total-rest" aria-live="polite" aria-atomic="true">0:00:00.000</strong>
                </div>
                <div class="summary-item">
                    <span>Total</span>
                    <strong id="total-time" aria-live="polite" aria-atomic="true">0:00:00.000</strong>
                </div>
            </div>
            <div id="controls-container">
                <button id="finalize-btn" class="control-btn">Finalizar y Guardar</button>
            </div>
            <div id="laps-container">
                <!-- Las vueltas se añadirán aquí dinámicamente -->
            </div>
        </div>
        <div id="sessions-view" style="display: none;">
            <div id="sessions-container">
                <h2>SESSIONS GUARDADES</h2>
                <div id="sessions-list">
                    <!-- Las sesiones guardadas se añadirán aquí -->
                </div>
            </div>
        </div>
    </div>
    <script>
	document.addEventListener('DOMContentLoaded', () => {
    // Referències a els elements del DOM
    const dateContainer = document.getElementById('date-container');
    const clockElement = document.getElementById('clock');
    const clockContainer = document.getElementById('clock-container');
    const totalWorkElement = document.getElementById('total-work');
    const totalRestElement = document.getElementById('total-rest');
    const totalTimeElement = document.getElementById('total-time');
    const lapsContainer = document.getElementById('laps-container');
    const finalizeBtn = document.getElementById('finalize-btn');
    const sessionsList = document.getElementById('sessions-list');
    const sessionsContainer = document.getElementById('sessions-container');
    const toggleViewBtn = document.getElementById('toggle-view-btn');
    const registrationView = document.getElementById('registration-view');
    const sessionsView = document.getElementById('sessions-view');

    let laps = [];
    let clockInterval;
    let isReadOnly = false;
    let isViewingSession = false; // Permite editar tipo en vista de sesión guardada
    let currentSessionKey = null; // Clave de la sesión en vista
    let isRecording = false;  // Add this line
    let sessionDirty = false;
    let pendingRename = null;
    let recordingName = 'Indeterminat';
    const sessionPrefix = 'stopwatch_session_';
    // Keep a reference to the temporary finalize handler used in view mode
    let finalizeViewHandler = null;

    const disketteIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" stroke-width="1.5" stroke="black" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2" /><path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M14 4l0 4l-6 0l0 -4" /></svg>`;
    const stopwatchIcon = `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 7V12H17M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    const playIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" stroke-width="2" stroke="#f0f0f0" fill="none">
        <path d="M7 4v16l13 -8z" />
    </svg>`;
    const workIcon = `
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
  <!-- Mancuerna W4: placas con sombrero/base y barra central -->
  <rect x="2" y="7" width="4" height="1" rx=".5"/>
  <rect x="2" y="8" width="4" height="8" rx="1.2"/>
  <rect x="2" y="16" width="4" height="1" rx=".5"/>
  <rect x="6.5" y="9.5" width="1.5" height="5" rx=".75"/>
  <rect x="8.5" y="11" width="7" height="2" rx="1"/>
  <rect x="16" y="9.5" width="1.5" height="5" rx=".75"/>
  <rect x="18" y="7" width="4" height="1" rx=".5"/>
  <rect x="18" y="8" width="4" height="8" rx="1.2"/>
  <rect x="18" y="16" width="4" height="1" rx=".5"/>
</svg>`;

    const restIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <!-- Cup body -->
        <path d="M3 10v5a3 3 0 0 0 3 3h6a3 3 0 0 0 3-3v-5z" />
        <!-- Handle -->
        <path d="M15 11h2a2 2 0 1 1 0 4h-2" />
        <!-- Base -->
        <path d="M5 20h10" />
        <!-- Steam -->
        <path d="M8 4c0 1 1 1 1 2s-1 1-1 2" />
        <path d="M11 3c0 1 1 1 1 2s-1 1-1 2" />
        <path d="M14 4c0 1 1 1 1 2s-1 1-1 2" />
    </svg>`;
    const totalIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
        <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
        <path d="M12 7v5l3 3" />
    </svg>`;
    const searchIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`;

    // --- Modal util ---
    const showModal = ({ title = '', message = '', okText = 'Aceptar', cancelText = 'Cancelar', type = 'confirm', defaultValue = '' } = {}) => {
        return new Promise((resolve) => {
            try {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            // Critical inline styles to guarantee centering and overlay behavior
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.65)'; // darker overlay
            overlay.style.backdropFilter = 'blur(2px)'; // slight blur for emphasis
            overlay.style.zIndex = '9999';

            const modal = document.createElement('div');
            modal.className = 'modal';
            // Ensure modal box styles exist even if CSS is missing
            modal.style.backgroundColor = 'var(--card-bg-color)';
            modal.style.border = '1px solid var(--accent-color)'; // stronger contrast border
            modal.style.borderRadius = '12px';
            modal.style.padding = '20px';
            modal.style.maxWidth = '400px';
            modal.style.width = '90%';
            modal.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)'; // stronger shadow
            modal.style.textAlign = 'center';
            // pop-in animation
            modal.style.transform = 'scale(0.96)';
            modal.style.opacity = '0';
            modal.style.transition = 'transform 120ms ease-out, opacity 120ms ease-out';
            modal.setAttribute('role', type === 'alert' ? 'alertdialog' : 'dialog');
            modal.setAttribute('aria-modal', 'true');

            const h3 = document.createElement('h3');
            h3.textContent = title || 'Pregunta';
            h3.style.fontSize = '1.6rem';
            h3.style.fontWeight = '700';
            h3.style.margin = '0 0 16px 0';
            modal.appendChild(h3);

            if (message) {
                const p = document.createElement('p');
                p.textContent = message;
                p.style.fontSize = '1.1rem';
                p.style.lineHeight = '1.6';
                p.style.margin = '0 0 20px 0';
                modal.appendChild(p);
            }

            let inputEl = null;
            if (type === 'prompt') {
                inputEl = document.createElement('input');
                inputEl.type = 'text';
                inputEl.value = defaultValue || '';
                inputEl.className = 'modal-input';
                modal.appendChild(inputEl);
                setTimeout(() => { inputEl.focus(); inputEl.select(); }, 0);
            }

            const buttons = document.createElement('div');
            buttons.className = 'modal-actions';

            const okBtn = document.createElement('button');
            const isDeleteAction = /eliminar|delete|suprimir/i.test((okText || title || ''));
            okBtn.innerHTML = isDeleteAction
                ? `${trashIcon} ${okText}`
                : `${okText}`;
            okBtn.addEventListener('click', () => {
                cleanup();
                if (type === 'prompt') resolve(inputEl.value);
                else resolve(true);
            });

            if (type !== 'alert') {
                const cancelBtn = document.createElement('button');
                cancelBtn.innerHTML = `${xIcon} ${cancelText}`;
                cancelBtn.addEventListener('click', () => { cleanup(); resolve(type === 'prompt' ? null : false); });
                // Style cancel immediately
                try { styleButton(cancelBtn, 'secondary'); } catch {}
                buttons.appendChild(cancelBtn);
            }

            // Style OK immediately
            try { styleButton(okBtn, isDeleteAction ? 'danger' : 'primary'); } catch {}
            buttons.appendChild(okBtn);
            modal.appendChild(buttons);
            overlay.appendChild(modal);

            const onKey = (e) => {
                if (e.key === 'Escape') { e.preventDefault(); cleanup(); resolve(type === 'prompt' ? null : false); }
                if (e.key === 'Enter') { e.preventDefault(); okBtn.click(); }
            };
            document.addEventListener('keydown', onKey);

            function cleanup() {
                document.removeEventListener('keydown', onKey);
                overlay.remove();
                document.body.style.overflow = originalOverflow;
                try { observer.disconnect(); } catch {}
            }

            const originalOverflow = document.body.style.overflow;
            document.body.style.overflow = 'hidden';
            document.body.appendChild(overlay);
            // trigger animation
            requestAnimationFrame(() => {
                modal.style.transform = 'scale(1)';
                modal.style.opacity = '1';
            });

            // Style buttons elegantly once they are added to the modal
            const styleButton = (btn, mode = 'secondary') => {
                const dangerColor = '#e74c3c';
                const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-color')?.trim() || '#00a6ff';
                const secondary = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color')?.trim() || '#999';

                btn.style.padding = '12px 18px';
                btn.style.borderRadius = '10px';
                btn.style.fontSize = '1rem';
                btn.style.cursor = 'pointer';
                btn.style.transition = 'filter 0.15s ease';
                btn.style.outline = 'none';
                btn.style.display = 'inline-flex';
                btn.style.alignItems = 'center';
                btn.style.gap = '8px';

                if (mode === 'danger') {
                    btn.style.border = `1px solid ${dangerColor}`;
                    btn.style.background = dangerColor;
                    btn.style.color = '#ffffff';
                } else if (mode === 'primary') {
                    btn.style.border = `1px solid ${accent}`;
                    btn.style.background = accent;
                    btn.style.color = '#ffffff';
                } else {
                    btn.style.border = `1px solid ${secondary}`;
                    btn.style.background = 'transparent';
                    btn.style.color = secondary;
                }

                btn.addEventListener('focus', () => {
                    btn.style.boxShadow = `0 0 0 3px ${accent}`;
                });
                btn.addEventListener('blur', () => {
                    btn.style.boxShadow = 'none';
                });
                btn.addEventListener('mouseover', () => {
                    btn.style.filter = 'brightness(1.06)';
                });
                btn.addEventListener('mouseout', () => {
                    btn.style.filter = 'none';
                });
            };

            const trashIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>';
            const xIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';

            const processButtons = () => {
                const btnNodes = modal.querySelectorAll('button, input[type="button"], input[type="submit"], a[role="button"], a.button');
                btnNodes.forEach((node) => {
                    let b = node;
                    if (b.__styled) return;
                    let txt = '';
                    if (b.tagName === 'INPUT') {
                        txt = (b.value || '').trim();
                    } else if (b.tagName === 'A') {
                        txt = (b.textContent || '').trim();
                    } else {
                        txt = (b.textContent || '').trim();
                    }
                    const normalized = txt.toLowerCase();
                    const okNorm = (okText || '').trim().toLowerCase();
                    const isOk = normalized === okNorm;
                    const isDelete = /eliminar|delete|suprimir/.test(okNorm || normalized);

                    // If it's an INPUT, convert to BUTTON to allow icons
                    if (b.tagName === 'INPUT') {
                        const newBtn = document.createElement('button');
                        newBtn.type = 'button';
                        // Transfer listeners by proxying click
                        newBtn.addEventListener('click', () => b.click());
                        b.replaceWith(newBtn);
                        b = newBtn;
                    } else if (b.tagName === 'A') {
                        // Convert anchors to button-like
                        b.setAttribute('role', 'button');
                        b.setAttribute('tabindex', '0');
                    }

                    // Prepend icons
                    if (isOk && isDelete && !b.__icon) {
                        b.innerHTML = `${trashIcon} ${txt}`;
                        b.__icon = true;
                    } else if (!isOk && !b.__icon) {
                        b.innerHTML = `${xIcon} ${txt}`;
                        b.__icon = true;
                    }
                    const mode = isOk ? (isDelete ? 'danger' : 'primary') : 'secondary';
                    styleButton(b, mode);
                    b.__styled = true;
                });
            };

            // Initial styling pass (in case buttons already exist)
            processButtons();

            // Observe for future changes (e.g., when buttons are appended later)
            const observer = new MutationObserver(() => {
                processButtons();
            });
            observer.observe(modal, { childList: true, subtree: true });

            // Safety: try a second pass shortly after in case actions were appended asynchronously
            setTimeout(processButtons, 0);
            } catch (err) {
                try { console.error('showModal fallback by error:', err); } catch {}
                const text = (message && String(message).trim().length) ? message : (title || 'Confirmar?');
                if (type === 'alert') {
                    alert(text);
                    resolve(true);
                } else if (type === 'prompt') {
                    const r = prompt(title || 'Introduir valor', defaultValue || '');
                    resolve(r);
                } else {
                    const ok = confirm(text);
                    resolve(ok);
                }
            }
        });
    };

    const formatDate = (date) => {
        const days = ['Diumenge', 'Dilluns', 'Dimarts', 'Dimecres', 'Dijous', 'Divendres', 'Dissabte'];
        const months = ['Gener', 'Febrer', 'Març', 'Abril', 'Maig', 'Juny', 'Juliol', 'Agost', 'Setembre', 'Octubre', 'Novembre', 'Desembre'];
        const dayName = days[date.getDay()];
        const monthName = months[date.getMonth()];
        return `${dayName}, ${date.getDate()} de ${monthName} de ${date.getFullYear()}`;
    };

    

    // --- Funcions de format i càlcul ---

    const formatTime = (date) => {
        // Formato del reloj: HH:MM:SS.ms con ms al 25% del tamaño
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        const milliseconds = String(date.getMilliseconds()).padStart(3, '0');
        return `${hours}:${minutes}:${seconds}<span style="font-size:0.5em; vertical-align: super">.${milliseconds}</span>`;
    };

    const formatDuration = (seconds) => {
        // Formato de duración: H:MM:SS.ms (horas sin relleno, minutos y segundos 2 dígitos)
        if (isNaN(seconds) || seconds < 0) return '0:00:00.000';
        const totalMilliseconds = Math.floor(seconds * 1000);
        const hours = Math.floor(totalMilliseconds / 3600000);
        const remainingAfterHours = totalMilliseconds % 3600000;
        const minutes = Math.floor(remainingAfterHours / 60000);
        const remainingMs = remainingAfterHours % 60000;
        const sec = Math.floor(remainingMs / 1000);
        const ms = remainingMs % 1000;
        return `${String(hours)}:${String(minutes).padStart(2, '0')}:${String(sec).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
    };

    // Duración compacta: sin ceros a la izquierda en minutos si no hay horas
    const formatDurationCompact = (seconds) => {
        if (isNaN(seconds) || seconds < 0) return '0:00.000';
        const totalMilliseconds = Math.floor(seconds * 1000);
        const hours = Math.floor(totalMilliseconds / 3600000);
        const remainingAfterHours = totalMilliseconds % 3600000;
        const minutes = Math.floor(remainingAfterHours / 60000);
        const remainingMs = remainingAfterHours % 60000;
        const sec = Math.floor(remainingMs / 1000);
        const ms = remainingMs % 1000;
        if (hours > 0) {
            return `${String(hours)}:${String(minutes).padStart(2, '0')}:${String(sec).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
        } else {
            return `${String(minutes)}:${String(sec).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
        }
    };

    const formatDurationHTML = (seconds) => {
        // Igual que formatDuration pero con ms en 25% del tamaño
        if (isNaN(seconds) || seconds < 0) return '0:00:00<span style="font-size:0.25em; vertical-align: super">.000</span>';
        const totalMilliseconds = Math.floor(seconds * 1000);
        const hours = Math.floor(totalMilliseconds / 3600000);
        const remainingAfterHours = totalMilliseconds % 3600000;
        const minutes = Math.floor(remainingAfterHours / 60000);
        const remainingMs = remainingAfterHours % 60000;
        const sec = Math.floor(remainingMs / 1000);
        const ms = String(remainingMs % 1000).padStart(3, '0');
        return `${String(hours)}:${String(minutes).padStart(2, '0')}:${String(sec).padStart(2, '0')}<span style="font-size:0.25em; vertical-align: super">.${ms}</span>`;
    };
    const formatSummaryDurationHTML = (seconds) => {
        // Igual que formatDuration pero con ms al 50% para el summary
        if (isNaN(seconds) || seconds < 0) return '0:00:00<span style="font-size:0.5em; vertical-align: super">.000</span>';
        const totalMilliseconds = Math.floor(seconds * 1000);
        const hours = Math.floor(totalMilliseconds / 3600000);
        const remainingAfterHours = totalMilliseconds % 3600000;
        const minutes = Math.floor(remainingAfterHours / 60000);
        const remainingMs = remainingAfterHours % 60000;
        const sec = Math.floor(remainingMs / 1000);
        const ms = String(remainingAfterHours % 1000 ?? remainingMs % 1000).padStart(3, '0');
        return `${String(hours)}:${String(minutes).padStart(2, '0')}:${String(sec).padStart(2, '0')}<span style="font-size:0.5em; vertical-align: super">.${ms}</span>`;
    };
    const formatDurationHTMLFull = (seconds) => {
        // Mismo tamaño para ms (sin reducción): H:MM:SS.ms
        if (isNaN(seconds) || seconds < 0) return '0:00:00.000';
        const totalMilliseconds = Math.floor(seconds * 1000);
        const hours = Math.floor(totalMilliseconds / 3600000);
        const remainingAfterHours = totalMilliseconds % 3600000;
        const minutes = Math.floor(remainingAfterHours / 60000);
        const remainingMs = remainingAfterHours % 60000;
        const sec = Math.floor(remainingMs / 1000);
        const ms = String(remainingMs % 1000).padStart(3, '0');
        return `${String(hours)}:${String(minutes).padStart(2, '0')}:${String(sec).padStart(2, '0')}.${ms}`;
    };

    const formatSessionName = (date) => {
        const y = date.getFullYear();
        const mo = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const mi = String(date.getMinutes()).padStart(2, '0');
        const s = String(date.getSeconds()).padStart(2, '0');
        return `${y}-${mo}-${d}_${h}-${mi}-${s}`;
    };

    // Helpers para parsear/renombrar sesiones
    const parseSessionKey = (fullKey) => {
        const fileName = fullKey.replace(sessionPrefix, ''); // yyyy-mm-dd_hh-mi-ss_<name>.txt
        // timestamp fijo de 19 chars (YYYY-MM-DD_HH-MM-SS)
        const timestamp = fileName.slice(0, 19);
        const nameWithExt = fileName.slice(20);
        const dot = nameWithExt.lastIndexOf('.');
        const name = dot > -1 ? nameWithExt.slice(0, dot) : nameWithExt;
        const [dateStr, timeStr] = timestamp.split('_');
        return { fileName, timestamp, dateStr, timeStr: timeStr.replaceAll('-', ':'), name };
    };

    const renameSession = (oldKey, newName) => {
        try {
            const data = localStorage.getItem(oldKey);
            if (data == null) return null;
            const { timestamp } = parseSessionKey(oldKey);
            const newFileName = `${timestamp}_${newName}.txt`;
            const newKey = sessionPrefix + newFileName;
            // Evitar colisiones simples
            if (newKey !== oldKey && localStorage.getItem(newKey) != null) {
                showModal({ title: 'Conflicte de nom', message: 'Ja existeix una sessió amb aquest nom.', type: 'alert', okText: 'D’acord' });
                return null;
            }
            localStorage.setItem(newKey, data);
            localStorage.removeItem(oldKey);
            return newKey;
        } catch (e) {
            console.error('Error reanomenant la sessió', e);
            // Use modal for error
            showModal({ title: 'Error', message: 'Error en reanomenar la sessió.', type: 'alert', okText: 'Tancar' });
            return null;
        }
    };

    // --- Lògica de vistes ---

    const toggleView = async () => {
        if (isRecording && !isReadOnly) {
            await showModal({ title: 'ATENCIÓ', message: 'Finalitza la sessió actual abans de veure les sessions desades.', type: 'alert', okText: 'D’acord' });
            return;
        }

        if (isReadOnly) {
            // En mode lectura, tancar vista de sessió amb confirmació i anar a sessions
            await closeSessionView(false);
            sessionsView.style.display = 'block';
            registrationView.style.display = 'none';
            toggleViewBtn.innerHTML = stopwatchIcon;
            toggleViewBtn.setAttribute('aria-label', 'Canviar a vista de registre');
            renderSessions();
        } else {
            const isSessionsView = sessionsView.style.display === 'block';
            if (isSessionsView) {
                sessionsView.style.display = 'none';
                registrationView.style.display = 'block';
                clockContainer.style.display = 'flex';
                finalizeBtn.style.display = 'block';
                toggleViewBtn.innerHTML = disketteIcon;
                toggleViewBtn.setAttribute('aria-label', 'Canviar a vista de sessions');
                
                // Refresh display
                dateElement.textContent = formatDate(new Date());
                startClock();
                updateInstructionText();
            } else {
                sessionsView.style.display = 'block';
                registrationView.style.display = 'none';
                toggleViewBtn.innerHTML = stopwatchIcon;
                toggleViewBtn.setAttribute('aria-label', 'Canviar a vista de registre');
            }
        }
    };

    // --- Lògica principal ---

    const updateSummary = () => {
        let totalWorkSeconds = 0;
        let totalRestSeconds = 0;

        if (laps.length > 1) {
            for (let i = 0; i < laps.length - 1; i++) {
                const duration = (laps[i + 1].time - laps[i].time) / 1000;
                if (laps[i].type === 'work') {
                    totalWorkSeconds += duration;
                } else {
                    totalRestSeconds += duration;
                }
            }
        }

        totalWorkElement.innerHTML = formatSummaryDurationHTML(totalWorkSeconds);
        totalRestElement.innerHTML = formatSummaryDurationHTML(totalRestSeconds);
        totalTimeElement.innerHTML = formatSummaryDurationHTML(totalWorkSeconds + totalRestSeconds);
    };

    const renderLaps = () => {
        // Limpiar contenedor
        while (lapsContainer.firstChild) lapsContainer.removeChild(lapsContainer.firstChild);
        laps.forEach((lap, index) => {
            const lapItem = document.createElement('div');
            lapItem.className = `lap-item ${lap.type}`;

            // Índice correlativo (1-based)
            const lapIndex = document.createElement('span');
            lapIndex.className = 'lap-index';
            lapIndex.textContent = String(index + 1);

            const lapTime = document.createElement('span');
            lapTime.className = 'lap-duration';
            const t = (lap.time instanceof Date) ? lap.time : new Date(lap.time);
            lapTime.innerHTML = formatTime(t);

            const lapNameInput = document.createElement('input');
            lapNameInput.className = 'lap-name';
            lapNameInput.type = 'text';
            lapNameInput.value = lap.name;
            lapNameInput.addEventListener('focus', (e) => e.target.select());
            lapNameInput.addEventListener('change', (e) => {
                if (!isReadOnly) {
                    laps[index].name = e.target.value;
                }
            });
            if (isReadOnly) {
                lapNameInput.readOnly = true;
            }

            const durationSpan = document.createElement('span');
            durationSpan.className = 'lap-time';

            if (index < laps.length - 1) {
                const nextRaw = laps[index + 1].time;
                const nextT = (nextRaw instanceof Date) ? nextRaw : new Date(nextRaw);
                const duration = (nextT - t) / 1000;
                durationSpan.innerHTML = formatSummaryDurationHTML(duration);
            } else if (!isReadOnly) {
                const now = new Date();
                const duration = (now - t) / 1000;
                durationSpan.innerHTML = formatSummaryDurationHTML(duration);
            }

            const lapTypeToggle = document.createElement('button');
            lapTypeToggle.className = `lap-type-toggle ${lap.type}`;
            const isWork = lap.type === 'work';
            lapTypeToggle.innerHTML = `${isWork ? workIcon : restIcon} ${isWork ? 'Treball' : 'Descans'}`;
            lapTypeToggle.style.display = 'flex';
            lapTypeToggle.style.alignItems = 'center';
            lapTypeToggle.style.gap = '5px';
            lapTypeToggle.setAttribute('role', 'button');
            lapTypeToggle.setAttribute('aria-pressed', String(isWork));
            lapTypeToggle.setAttribute('tabindex', '0');
            lapTypeToggle.setAttribute('aria-label', isWork ? 'Canvia a descans' : 'Canvia a treball');
            lapTypeToggle.addEventListener('click', () => {
                if (!isReadOnly || isViewingSession) {
                    laps[index].type = laps[index].type === 'work' ? 'rest' : 'work';
                    const nowIsWork = laps[index].type === 'work';
                    lapTypeToggle.setAttribute('aria-pressed', String(nowIsWork));
                    lapTypeToggle.setAttribute('aria-label', nowIsWork ? 'Canvia a descans' : 'Canvia a treball');
                    if (isViewingSession) {
                        sessionDirty = true;
                        const saveBtnEnable = document.getElementById('session-save-btn');
                        if (saveBtnEnable) saveBtnEnable.disabled = false;
                    }
                    renderLaps();
                    updateSummary();
                }
            });
            lapTypeToggle.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    lapTypeToggle.click();
                }
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'delete-btn';
            deleteBtn.title = 'Eliminar volta';
            deleteBtn.setAttribute('aria-label', 'Eliminar volta');
            deleteBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                <path d="M10 11v6"/>
                <path d="M14 11v6"/>
                <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
              </svg>`;
            deleteBtn.addEventListener('click', () => {
                if (!isReadOnly && confirm(`Segur que vols eliminar "${lap.name}"?`)) {
                    laps.splice(index, 1);
                    renderLaps();
                    updateSummary();
                }
            });

            // Place delete button first (leftmost) when editable
            if (!isReadOnly) {
                lapItem.appendChild(deleteBtn);
            }
            lapItem.appendChild(lapIndex);
            lapItem.appendChild(lapTime);
            lapItem.appendChild(lapNameInput);
            lapItem.appendChild(durationSpan);
            if (!isReadOnly || isViewingSession) {
                lapItem.appendChild(lapTypeToggle);
            }
            lapsContainer.prepend(lapItem);
        });
    };

    const updateInstructionText = () => {
        instructionText.textContent = isRecording 
            ? 'PREM AQUÍ PER MARCAR UNA VOLTA'
            : 'PREM AQUÍ PER INICIAR UNA SESSIÓ';
    };

    // Mostrar/ocultar campo de nombre durante la grabación
    const mountRecordingNameRow = () => {
        const existing = document.getElementById('recording-name-row');
        if (existing) return;
        const row = document.createElement('div');
        row.id = 'recording-name-row';
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '10px';
        row.style.margin = '10px 0';

        const label = document.createElement('span');
        label.textContent = 'SESSIÓ:';
        label.style.opacity = '0.9';

        const input = document.createElement('input');
        input.type = 'text';
        input.value = recordingName || 'Indeterminat';
        input.placeholder = 'Nom de la sessió';
        input.style.flex = '1 1 auto';
        input.style.minWidth = '0';
        input.style.border = '1px solid #3a3a3a';
        input.style.background = 'transparent';
        input.style.color = '#f0f0f0';
        input.style.borderRadius = '6px';
        input.style.padding = '6px 8px'; // menor margen interno
        input.style.fontSize = '1.2rem'; // texto más grande
        input.style.fontWeight = '700'; // negrita
        input.addEventListener('input', (e) => {
            recordingName = String(e.target.value ?? '').trimStart();
        });

        row.appendChild(label);
        row.appendChild(input);

        // Botón de edición (lápiz) para enfocar y preseleccionar
        const editBtn = document.createElement('button');
        editBtn.setAttribute('aria-label', 'Editar nom de la sessió');
        editBtn.title = 'Editar nom';
        editBtn.style.display = 'flex';
        editBtn.style.alignItems = 'center';
        editBtn.style.justifyContent = 'center';
        editBtn.style.padding = '6px';
        editBtn.style.borderRadius = '6px';
        editBtn.style.border = '1px solid var(--secondary-color)';
        editBtn.style.background = 'transparent';
        editBtn.style.color = 'var(--secondary-color)';
        editBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9"/>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/>
          </svg>`;
        editBtn.addEventListener('click', () => {
            input.focus();
            input.select();
        });

        row.appendChild(editBtn);

        // Insertar debajo del reloj
        const dateContainerEl = document.getElementById('date-container');
        if (dateContainerEl && dateContainerEl.parentNode) {
            dateContainerEl.parentNode.insertBefore(row, clockContainer.nextSibling);
        } else {
            // Fallback: después del clockContainer
            clockContainer.parentNode.insertBefore(row, clockContainer.nextSibling);
        }
    };

    const unmountRecordingNameRow = () => {
        const existing = document.getElementById('recording-name-row');
        if (existing) existing.remove();
    };

    const addLap = () => {
        if (isReadOnly) return;
        const now = new Date();
        if (!isRecording) {
            isRecording = true;
            finalizeBtn.textContent = 'FINALITZAR SESSIÓ';
            updateInstructionText();
            // Montar campo de nombre de sesión para grabación
            mountRecordingNameRow();
        }
        laps.push({
            time: now,
            name: `Volta ${laps.length + 1}`,
            type: 'work'
        });
        renderLaps();
        updateSummary();
    };

    const updateLastLapDuration = () => {
        if (isReadOnly || laps.length === 0) return;
        const lastLapElement = lapsContainer.firstChild;
        if (lastLapElement) {
            const durationSpan = lastLapElement.querySelector('.lap-time');
            if (durationSpan) {
                const now = new Date();
                const lastLap = laps[laps.length - 1];
                const duration = (now - lastLap.time) / 1000;
                durationSpan.innerHTML = formatSummaryDurationHTML(duration);
            }
        }
    };

    const startClock = () => {
        clearInterval(clockInterval);
        clockInterval = setInterval(() => {
            clockElement.innerHTML = formatTime(new Date());
            updateLastLapDuration();
        }, 10); // Update more frequently for milliseconds
        clockElement.innerHTML = formatTime(new Date());
    };

    const finalizeSession = async () => {
        // Safety: ensure view-mode finalize handler is detached
        try {
            if (finalizeViewHandler) {
                finalizeBtn.removeEventListener('click', finalizeViewHandler);
                finalizeViewHandler = null;
            }
        } catch {}
        // If currently recording, mark a lap as if the user tapped the clock
        if (isRecording && typeof clockContainer !== 'undefined' && clockContainer) {
            try { clockContainer.click(); } catch {}
            // Allow the click handler (addLap) to run before proceeding
            await new Promise(r => setTimeout(r, 25));
        }
        // If still no laps, inform the user and abort finalize
        if (laps.length === 0) {
            try {
                await showModal({ title: 'Informació', message: 'Prem sobre el Rellotge superior per inicial el reigstres de voltes.', type: 'alert', okText: 'D’acord' });
            } catch {}
            return;
        }

        const timestamp = formatSessionName(new Date(laps[0].time));
        const sessionNameValue = String(recordingName || '').trim() || 'Indeterminat';
        const fullSessionName = `${timestamp}_${sessionNameValue}.txt`;
        try {
            localStorage.setItem(sessionPrefix + fullSessionName, JSON.stringify(laps));
            laps = [];
            isRecording = false;
            recordingName = 'Indeterminat';
            unmountRecordingNameRow();
            renderLaps();
            updateSummary();
            // Mostrar directamente la vista de sesiones y refrescar lista
            renderSessions();
            sessionsView.style.display = 'block';
            registrationView.style.display = 'none';
            toggleViewBtn.innerHTML = stopwatchIcon;
        } catch (e) {
            await showModal({ title: 'Error', message: "Error en desar la sessió. L'emmagatzematge pot estar ple.", type: 'alert', okText: 'Tancar' });
            console.error(e);
        }
    };

    const renderSessions = () => {
        sessionsList.innerHTML = '';
        const sessions = Object.keys(localStorage)
            .filter(key => key.startsWith(sessionPrefix))
            .sort((a, b) => {
                // Extract date from session key (format: stopwatch_session_yyyy-mm-dd_hh-mi-ss)
                const dateA = a.split('_')[2] + a.split('_')[3];
                const dateB = b.split('_')[2] + b.split('_')[3];
                return dateB.localeCompare(dateA); // Most recent first
            });

        // Mantener visible el contenedor y el título aunque no haya sesiones
        sessionsContainer.parentElement.style.display = 'block';
        
        // Rest of renderSessions remains the same
        // Mostrar mensaje vacío cuando no hay sesiones
        if (sessions.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.textContent = 'No hi ha sessions desades';
            emptyMsg.style.color = '#aaa';
            emptyMsg.style.textAlign = 'center';
            emptyMsg.style.padding = '10px 0';
            sessionsList.appendChild(emptyMsg);
            return;
        }

        sessions.forEach(sessionKey => {
            const sessionItem = document.createElement('div');
            sessionItem.className = 'session-item';

            const info = parseSessionKey(sessionKey);

            const nameSpan = document.createElement('span');
            nameSpan.style.marginTop = '4px';
            nameSpan.style.display = 'block';
            nameSpan.style.fontSize = '0.9em';
            nameSpan.style.opacity = '0.9';
            nameSpan.textContent = info.fileName;

            const detail = document.createElement('div');
            detail.style.color = '#f0f0f0';
            detail.style.fontSize = '1.1rem';
            detail.style.fontWeight = '600';
            // Calculate total duration and laps count from saved data
            let lapsCount = 0;
            let totalSeconds = 0;
            try {
                const saved = JSON.parse(localStorage.getItem(sessionKey));
                if (Array.isArray(saved) && saved.length > 0) {
                    lapsCount = saved.length;
                    for (let i = 0; i < saved.length - 1; i++) {
                        const t0 = new Date(saved[i].time);
                        const t1 = new Date(saved[i + 1].time);
                        totalSeconds += (t1 - t0) / 1000;
                    }
                }
            } catch {}
            const totalStr = lapsCount > 0 ? `  |  ${formatDurationCompact(totalSeconds)}  |  ${lapsCount} voltes` : '';
            detail.textContent = `${info.dateStr}  |  ${info.timeStr}${totalStr}`;

            // First line: session name (bold and larger)
            const nameLine = document.createElement('div');
            nameLine.textContent = info.name;
            nameLine.style.color = '#f0f0f0';
            nameLine.style.fontSize = '1.3rem';
            nameLine.style.fontWeight = '700';
            nameLine.style.marginBottom = '2px';

            // Left column with two rows (filename, and date | time | name)
            const infoCol = document.createElement('div');
            infoCol.style.display = 'flex';
            infoCol.style.flexDirection = 'column';
            infoCol.style.flex = '1 1 auto';
            // Order: name (big/bold), date|time, file name (bottom, smaller)
            infoCol.appendChild(nameLine);
            infoCol.appendChild(detail);
            infoCol.appendChild(nameSpan);

            // Right column with actions
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.flexDirection = 'column';
            buttonsContainer.style.gap = '5px';

            const viewBtn = document.createElement('button');
            viewBtn.innerHTML = `${searchIcon}`;
            viewBtn.setAttribute('aria-label', 'Veure');
            viewBtn.title = 'Veure';
            viewBtn.style.display = 'flex';
            viewBtn.style.alignItems = 'center';
            viewBtn.style.gap = '6px';
            viewBtn.addEventListener('click', () => viewSession(sessionKey));

            buttonsContainer.appendChild(viewBtn);

            // Left delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.setAttribute('aria-label', 'Eliminar sessió');
            deleteBtn.title = 'Eliminar';
            deleteBtn.style.display = 'flex';
            deleteBtn.style.alignItems = 'center';
            deleteBtn.style.justifyContent = 'center';
            deleteBtn.style.padding = '6px';
            deleteBtn.style.borderRadius = '6px';
            deleteBtn.style.border = '1px solid #e74c3c';
            deleteBtn.style.background = 'transparent';
            deleteBtn.style.color = '#e74c3c';
            deleteBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                <path d="M10 11v6"/>
                <path d="M14 11v6"/>
                <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
              </svg>`;
            deleteBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                const ok = await showModal({
                    title: 'Eliminar sessió',
                    message: `Segur que vols eliminar la sessió "${sessionKey.replace(sessionPrefix, '')}"?`,
                    okText: 'Eliminar',
                    cancelText: 'Cancel·lar',
                    type: 'confirm'
                });
                if (ok) {
                    localStorage.removeItem(sessionKey);
                    // Si estamos viendo esta sesión, cerrar la vista y volver a la lista
                    if (typeof isViewingSession !== 'undefined' && isViewingSession && currentSessionKey === sessionKey) {
                        if (typeof closeSessionView === 'function') {
                            await closeSessionView(true);
                        }
                        const sessionsViewEl = document.getElementById('sessions-view');
                        const registrationViewEl = document.getElementById('registration-view');
                        if (sessionsViewEl && registrationViewEl) {
                            sessionsViewEl.style.display = 'block';
                            registrationViewEl.style.display = 'none';
                        }
                    }
                    renderSessions();
                }
            });

            // Append in order: delete | info | actions
            sessionItem.appendChild(deleteBtn);
            sessionItem.appendChild(infoCol);
            sessionItem.appendChild(buttonsContainer);
            sessionsList.appendChild(sessionItem);
        });
    };

    const viewSession = (sessionKey) => {
        let savedLaps = null;
        try {
            savedLaps = JSON.parse(localStorage.getItem(sessionKey));
        } catch {}
        try {
            let details = null;
            if (Array.isArray(savedLaps)) {
                details = savedLaps.map((lap, i) => {
                    const t = (lap.time instanceof Date) ? lap.time : new Date(lap.time);
                    let nextDur = null;
                    if (i < savedLaps.length - 1) {
                        const nraw = savedLaps[i + 1].time;
                        const nt = (nraw instanceof Date) ? nraw : new Date(nraw);
                        nextDur = (nt - t) / 1000;
                    }
                    return {
                        index: i + 1,
                        timeISO: t.toISOString(),
                        type: lap.type,
                        name: lap.name,
                        nextDurationSec: nextDur,
                        nextDurationFmt: nextDur != null ? formatDurationCompact(nextDur) : null
                    };
                });
            }
        } catch {}
        if (!Array.isArray(savedLaps) || savedLaps.length === 0) {
            showModal({ title: 'Sessió buida', message: 'Aquesta sessió no conté voltes.', type: 'alert', okText: 'Tancar' });
            return;
        }
        if (savedLaps) {
            isReadOnly = true;
            isViewingSession = true;
            currentSessionKey = sessionKey;
            laps = savedLaps.map(lap => ({...lap, time: new Date(lap.time)}));
            sessionDirty = false;
            pendingRename = null;
            
            // Switch to registration view first
            sessionsView.style.display = 'none';
            registrationView.style.display = 'block';
            
            // Create top bar container
            const topBar = document.createElement('div');
            topBar.id = 'session-top-bar';
            topBar.style.position = 'fixed';
            topBar.style.top = '0';
            topBar.style.left = '0';
            topBar.style.width = '100%';
            topBar.style.padding = '10px';
            topBar.style.backgroundColor = '#333';
            topBar.style.zIndex = '1000';
            topBar.style.display = 'flex';
            topBar.style.justifyContent = 'space-between';
            topBar.style.boxSizing = 'border-box';

            finalizeBtn.style.margin = '0';
            finalizeBtn.textContent = 'Tancar Vista';
            // Ensure previous handlers are cleared properly
            try { finalizeBtn.removeEventListener('click', finalizeSession); } catch {}
            if (finalizeViewHandler) {
                try { finalizeBtn.removeEventListener('click', finalizeViewHandler); } catch {}
            }
            finalizeViewHandler = async () => {
                await closeSessionView(false);
                sessionsView.style.display = 'block';
                registrationView.style.display = 'none';
                toggleViewBtn.innerHTML = stopwatchIcon;
                renderSessions();
            };
            finalizeBtn.addEventListener('click', finalizeViewHandler);
            topBar.appendChild(finalizeBtn);

            // Action buttons (Delete, Share, Share CSV) same as sessions list
            const actions = document.createElement('div');
            actions.style.display = 'flex';
            actions.style.gap = '8px';

            const viewDeleteBtn = document.createElement('button');
            viewDeleteBtn.type = 'button';
            viewDeleteBtn.textContent = 'Eliminar';
            viewDeleteBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); deleteSession(sessionKey); });

            const viewShareBtn = document.createElement('button');
            viewShareBtn.textContent = 'Compartir';
            viewShareBtn.addEventListener('click', () => shareSession(sessionKey));

            const viewShareCsvBtn = document.createElement('button');
            viewShareCsvBtn.textContent = 'Compartir CSV';
            viewShareCsvBtn.addEventListener('click', () => shareSessionCSV(sessionKey));


            actions.appendChild(viewDeleteBtn);
            actions.appendChild(viewShareBtn);
            actions.appendChild(viewShareCsvBtn);
            topBar.appendChild(actions);
            document.body.insertBefore(topBar, document.body.firstChild);
            
            // Add margin to main container to account for fixed top bar
            registrationView.style.marginTop = '60px';
            
            // Hide only the clock text to keep laps list visible
            try { clockElement.style.display = 'none'; } catch {}
            try { clockContainer.style.display = 'none'; } catch {}
            
            // Remove existing session-info if present to avoid duplicates
            const existingSessionInfo = document.getElementById('session-info');
            if (existingSessionInfo) {
                existingSessionInfo.remove();
            }

            // Create session info container
            const sessionInfoContainer = document.createElement('div');
            sessionInfoContainer.id = 'session-info';
            sessionInfoContainer.style.textAlign = 'center';
            sessionInfoContainer.style.marginBottom = '20px';
            sessionInfoContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            sessionInfoContainer.style.padding = '20px';
            sessionInfoContainer.style.borderRadius = '8px';
            
            const sessionDate = laps.length > 0 ? new Date(laps[0].time) : new Date();
            const dateText = document.createElement('div');
            dateText.textContent = formatDate(sessionDate);
            dateText.style.fontSize = '1.2em';
            dateText.style.marginBottom = '10px';
            
            const timeText = document.createElement('div');
            const sessionTime = laps.length > 0 ? new Date(laps[0].time) : new Date();
            timeText.innerHTML = `Hora d'inici: ${formatTime(sessionTime)}`;
            timeText.style.fontSize = '1.1em';
            
            sessionInfoContainer.appendChild(dateText);
            sessionInfoContainer.appendChild(timeText);
            
            clockContainer.parentNode.insertBefore(sessionInfoContainer, clockContainer);

            // Session name row with edit icon below info box
            const existingNameRow = document.getElementById('session-name-row');
            if (existingNameRow) existingNameRow.remove();
            const nameRow = document.createElement('div');
            nameRow.id = 'session-name-row';
            nameRow.style.display = 'flex';
            nameRow.style.alignItems = 'center';
            nameRow.style.gap = '10px';
            nameRow.style.margin = '10px 0 20px 0';
            nameRow.style.width = '100%';
            nameRow.style.boxSizing = 'border-box';

            const namePrefix = document.createElement('span');
            namePrefix.textContent = 'SESSIÓ:';
            namePrefix.style.fontWeight = '400';
            namePrefix.style.opacity = '0.9';
            namePrefix.style.flex = '0 0 auto';
            namePrefix.style.textAlign = 'left';

            const nameLabel = document.createElement('span');
            const parsedNow = parseSessionKey(currentSessionKey || sessionKey);
            nameLabel.textContent = parsedNow.name || 'Sessió';
            nameLabel.style.fontSize = '1.3em';
            nameLabel.style.fontWeight = '600';
            nameLabel.style.flex = '1 1 auto';
            nameLabel.style.textAlign = 'center';

            const actionsRight = document.createElement('div');
            actionsRight.style.display = 'flex';
            actionsRight.style.gap = '8px';
            actionsRight.style.alignItems = 'center';
            actionsRight.style.flex = '0 0 auto';

            const editBtn = document.createElement('button');
            editBtn.setAttribute('aria-label', 'Editar nom de la sessió');
            editBtn.title = 'Editar nom';
            editBtn.style.display = 'flex';
            editBtn.style.alignItems = 'center';
            editBtn.style.justifyContent = 'center';
            editBtn.style.padding = '6px';
            editBtn.style.borderRadius = '6px';
            editBtn.style.border = '1px solid var(--secondary-color)';
            editBtn.style.background = 'transparent';
            editBtn.style.color = 'var(--secondary-color)';
            editBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 20h9"/>
                  <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                </svg>`;
            editBtn.addEventListener('click', async () => {
                const currentInfo = parseSessionKey(currentSessionKey || sessionKey);
                const newName = await showModal({ title: 'Editar nom', type: 'prompt', defaultValue: currentInfo.name || 'Sessió', okText: 'Desar', cancelText: 'Cancel·lar' });
                if (!newName) return;
                pendingRename = newName;
                nameLabel.textContent = newName;
                sessionDirty = true;
            });
            actionsRight.appendChild(editBtn);

            nameRow.appendChild(namePrefix);
            nameRow.appendChild(nameLabel);
            nameRow.appendChild(actionsRight);
            sessionInfoContainer.parentNode.insertBefore(nameRow, sessionInfoContainer.nextSibling);
            
            // Update display
            try { clearInterval(clockInterval); } catch {}
            try { renderLaps(); } catch (e) { console.error('renderLaps error', e); }
            try { updateSummary(); } catch (e) { console.error('updateSummary error', e); }
            try { lapsContainer.style.display = 'flex'; } catch {}
            // Fallback: if nothing rendered but there are laps, render minimal rows
            try {
                if (laps.length > 0 && lapsContainer.childElementCount === 0) {
                    const frag = document.createDocumentFragment();
                    laps.forEach((lap, i) => {
                        const row = document.createElement('div');
                        row.className = 'lap-item';
                        row.textContent = `#${i + 1} - ${new Date(lap.time).toLocaleTimeString()} - ${lap.name || ''}`;
                        frag.appendChild(row);
                    });
                    lapsContainer.appendChild(frag);
                }
            } catch {}
            try { lapsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
        }
    };

    const closeSessionView = async (skipPrompt = false) => {
        try {
            if (!skipPrompt && sessionDirty && currentSessionKey) {
                const ok = await showModal({ title: 'Desar canvis?', message: 'Vols desar els canvis?', okText: 'Desar', cancelText: 'No desar', type: 'confirm' });
                if (ok) {
                    // Guardar cambios (rename + tipos)
                    if (pendingRename && pendingRename.trim() !== '') {
                        const { timestamp } = parseSessionKey(currentSessionKey);
                        const newFileName = `${timestamp}_${pendingRename}.txt`;
                        const newKey = sessionPrefix + newFileName;
                        localStorage.setItem(newKey, JSON.stringify(laps));
                        if (newKey !== currentSessionKey) {
                            localStorage.removeItem(currentSessionKey);
                            currentSessionKey = newKey;
                        }
                    } else {
                        localStorage.setItem(currentSessionKey, JSON.stringify(laps));
                    }
                }
            }
        } catch (e) {
            console.error('Error en tancar la vista de sessió', e);
            await showModal({ title: 'Error', message: 'Error en desar els canvis.', type: 'alert', okText: 'Tancar' });
        } finally {
            sessionDirty = false;
            pendingRename = null;
        }
        isReadOnly = false;
        isViewingSession = false;
        currentSessionKey = null;
        laps = [];
        
        // Remove top bar and reset margins
        const topBar = document.getElementById('session-top-bar');
        if (topBar) {
            topBar.remove();
        }
        registrationView.style.marginTop = '0';
        // Restore finalize button to default behavior and remove view handler
        if (finalizeViewHandler) {
            try { finalizeBtn.removeEventListener('click', finalizeViewHandler); } catch {}
            finalizeViewHandler = null;
        }
        try { finalizeBtn.removeEventListener('click', finalizeSession); } catch {}
        finalizeBtn.addEventListener('click', finalizeSession);
        
        // Remove session-info if exists
        const existingSessionInfo = document.getElementById('session-info');
        if (existingSessionInfo) existingSessionInfo.remove();
        // Remove session-name row if exists
        const existingNameRow2 = document.getElementById('session-name-row');
        if (existingNameRow2) existingNameRow2.remove();

        // Reset finalize button position and text
        finalizeBtn.style.position = 'static';
        finalizeBtn.textContent = isRecording ? 'Finalitzar i Desar' : 'PREM EL RELLOTGE PER COMENÇAR';
        finalizeBtn.removeEventListener('click', closeSessionView);
        finalizeBtn.addEventListener('click', finalizeSession);
        // Ensure finalize button is back in its original container and visible
        const controlsContainer = document.getElementById('controls-container');
        if (controlsContainer && !controlsContainer.contains(finalizeBtn)) {
            controlsContainer.appendChild(finalizeBtn);
        }
        finalizeBtn.style.display = 'block';
        finalizeBtn.style.margin = '';
        // Restore registration view UI state
        clockContainer.style.display = 'flex';
        try { clockElement.style.display = ''; } catch {}
        renderLaps();
        updateSummary();
        try { updateInstructionText && updateInstructionText(); } catch {}
        try { dateElement && (dateElement.textContent = formatDate(new Date())); } catch {}
        try { startClock(); } catch {}
        // Caller decides which view to show next
    };

    const deleteSession = async (sessionKey) => {
        const ok = await showModal({ title: 'Eliminar sessió', message: `Segur que vols eliminar la sessió "${sessionKey.replace(sessionPrefix, '')}"?`, okText: 'Eliminar', cancelText: 'Cancel·lar', type: 'confirm' });
        if (ok) {
            localStorage.removeItem(sessionKey);
            // If we are currently viewing this session, close the view and go back to the list
            if (isViewingSession && currentSessionKey === sessionKey) {
                await closeSessionView(true);
                sessionsView.style.display = 'block';
                registrationView.style.display = 'none';
            }
            renderSessions();
        }
    };

    const shareSession = (sessionKey) => {
        const savedLaps = JSON.parse(localStorage.getItem(sessionKey));
        if (savedLaps) {
            const sessionName = sessionKey.replace(sessionPrefix, '');
            const startDate = new Date(savedLaps[0].time);
            const startDateStr = `${String(startDate.getFullYear())}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
            const startTimeStr = `${String(startDate.getHours()).padStart(2, '0')}:${String(startDate.getMinutes()).padStart(2, '0')}:${String(startDate.getSeconds()).padStart(2, '0')}.${String(startDate.getMilliseconds()).padStart(3, '0')}`;

            let totalWorkSeconds = 0;
            let totalRestSeconds = 0;

            let shareText = `Sesión: ${sessionName}\nFecha: ${startDateStr}\nHora inicio: ${startTimeStr}\n\n`;
            // Encabezado (tabulado)
            shareText += `#\tHora\tTipo\tNombre\tDuración` + "\n";

            savedLaps.forEach((lap, index) => {
                const lapTime = new Date(lap.time);
                const lapTimeStr = `${String(lapTime.getHours()).padStart(2, '0')}:${String(lapTime.getMinutes()).padStart(2, '0')}:${String(lapTime.getSeconds()).padStart(2, '0')}.${String(lapTime.getMilliseconds()).padStart(3, '0')}`;
                const lapTypeLabel = lap.type === 'work' ? 'Trabajo' : 'Descanso';
                let line = `${index + 1}\t${lapTimeStr}\t${lapTypeLabel}\t${lap.name}`;
                if (index < savedLaps.length - 1) {
                    const nextTime = new Date(savedLaps[index + 1].time);
                    const duration = (nextTime - lapTime) / 1000;
                    if (lap.type === 'work') totalWorkSeconds += duration; else totalRestSeconds += duration;
                    line += `\t${formatDuration(duration)}`;
                }
                shareText += line + "\n";
            });

            const totalTimeSeconds = totalWorkSeconds + totalRestSeconds;
            shareText += `\nResumen:\n`;
            shareText += `  Trabajo: ${formatDuration(totalWorkSeconds)}\n`;
            shareText += `  Descanso: ${formatDuration(totalRestSeconds)}\n`;
            shareText += `  Total: ${formatDuration(totalTimeSeconds)}\n`;

            if (navigator.share) {
                navigator.share({
                    title: `Sesión: ${sessionName}`,
                    text: shareText,
                }).catch(() => {});
            } else {
                alert("La función de compartir no está disponible en este navegador. Puedes copiar el texto manualmente.");
                prompt("Copia este texto:", shareText);
            }
        }
    };

    const shareSessionCSV = (sessionKey) => {
        const savedLaps = JSON.parse(localStorage.getItem(sessionKey));
        if (!savedLaps) return;
        const sessionName = sessionKey.replace(sessionPrefix, '');
        const startDate = new Date(savedLaps[0].time);
        const startDateStr = `${String(startDate.getFullYear())}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
        const startTimeStr = `${String(startDate.getHours()).padStart(2, '0')}:${String(startDate.getMinutes()).padStart(2, '0')}:${String(startDate.getSeconds()).padStart(2, '0')}.${String(startDate.getMilliseconds()).padStart(3, '0')}`;

        let csv = `Sesion,${sessionName}\nFecha,${startDateStr}\nHora inicio,${startTimeStr}\n\n`;
        csv += `#;Hora;Tipo;Nombre;Duracion\n`; // cabecera CSV con ; separador

        let totalWorkSeconds = 0;
        let totalRestSeconds = 0;

        savedLaps.forEach((lap, index) => {
            const lapTime = new Date(lap.time);
            const lapTimeStr = `${String(lapTime.getHours()).padStart(2, '0')}:${String(lapTime.getMinutes()).padStart(2, '0')}:${String(lapTime.getSeconds()).padStart(2, '0')}.${String(lapTime.getMilliseconds()).padStart(3, '0')}`;
            const lapTypeLabel = lap.type === 'work' ? 'Trabajo' : 'Descanso';
            let durationStr = '';
            if (index < savedLaps.length - 1) {
                const nextTime = new Date(savedLaps[index + 1].time);
                const duration = (nextTime - lapTime) / 1000;
                if (lap.type === 'work') totalWorkSeconds += duration; else totalRestSeconds += duration;
                durationStr = formatDuration(duration);
            }
            // Escapar comillas en nombre
            const safeName = String(lap.name).replaceAll('"', '""');
            csv += `${index + 1};${lapTimeStr};${lapTypeLabel};"${safeName}";${durationStr}\n`;
        });

        const totalTimeSeconds = totalWorkSeconds + totalRestSeconds;
        csv += `\nResumen;Trabajo;${formatDuration(totalWorkSeconds)}\n`;
        csv += `Resumen;Descanso;${formatDuration(totalRestSeconds)}\n`;
        csv += `Resumen;Total;${formatDuration(totalTimeSeconds)}\n`;

        if (navigator.share && navigator.canShare && navigator.canShare({ text: csv })) {
            navigator.share({ title: `Sesión CSV: ${sessionName}`, text: csv })
                .catch(() => {});
        } else {
            // Fallback: prompt para copiar
            prompt('Copia el CSV:', csv);
        }
    };

    // --- Inicialització ---
    // Create app title if it doesn't exist
    let appTitle = document.getElementById('app-title');
    if (!appTitle) {
        appTitle = document.createElement('div');
        appTitle.id = 'app-title';
        appTitle.textContent = 'CONTROL DE VOLTES';
        document.body.appendChild(appTitle);
    }

    // Set initial icon for registration view
    toggleViewBtn.innerHTML = disketteIcon;
    toggleViewBtn.setAttribute('role', 'button');
    toggleViewBtn.setAttribute('tabindex', '0');
    toggleViewBtn.setAttribute('aria-label', 'Canviar a vista de sessions');
    toggleViewBtn.addEventListener('click', toggleView);
    toggleViewBtn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleView();
        }
    });
    clockContainer.addEventListener('click', addLap);
    clockContainer.setAttribute('role', 'button');
    clockContainer.setAttribute('tabindex', '0');
    clockContainer.setAttribute('aria-label', 'Rellotge, prem per marcar volta o començar');
    clockContainer.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            addLap();
        }
    });
    finalizeBtn.addEventListener('click', finalizeSession);
    startClock();
    renderSessions();

    // Ocultar vista de sessions a l'inici
    sessionsView.style.display = 'none';
    registrationView.style.display = 'block';

    // Actualitzar text del botó finalitzar
    finalizeBtn.textContent = 'PREM EL RELLOTGE PER COMENÇAR';

    // Clear and rebuild clock container
    clockContainer.innerHTML = '';
    
    // Add date first
    const dateElement = document.createElement('div');
    dateElement.style.fontSize = '1.2em';
    dateElement.style.marginBottom = '15px';
    dateElement.style.opacity = '0.8';
    dateElement.textContent = formatDate(new Date());
    clockContainer.appendChild(dateElement);

    // Modify timeContainer styles
    const timeContainer = document.createElement('div');
    timeContainer.style.display = 'flex';
    timeContainer.style.alignItems = 'center';
    timeContainer.style.width = '100%';
    timeContainer.style.justifyContent = 'space-between';
    timeContainer.style.padding = '0 20px';

    const playIconSpan = document.createElement('span');
    playIconSpan.innerHTML = playIcon;
    playIconSpan.style.display = 'flex';
    playIconSpan.style.alignItems = 'center';
    playIconSpan.style.flexShrink = '0';

    clockElement.style.fontSize = '5rem';
    clockElement.style.flex = '1';
    clockElement.style.textAlign = 'center';
    clockElement.style.margin = '0 20px';
    clockElement.style.fontFamily = '"Arial Narrow", Arial, sans-serif';
    clockElement.style.letterSpacing = '-0.05em';

    timeContainer.appendChild(playIconSpan);
    timeContainer.appendChild(clockElement);
    clockContainer.appendChild(timeContainer);

    // Update clockElement styles
    clockElement.style.fontSize = 'min(18vw, 5rem)';  // Larger responsive font
    clockElement.style.lineHeight = '1';
    clockElement.style.fontWeight = 'bold';
    clockElement.style.letterSpacing = '-0.02em';

    // Add instruction text
    const instructionText = document.createElement('div');
    instructionText.textContent = 'PREM AQUÍ PER COMENÇAR A REGISTRAR UNA SESSIÓ';
    instructionText.style.fontSize = '0.8em';
    instructionText.style.opacity = '0.7';
    instructionText.style.marginTop = '10px';
    clockContainer.appendChild(instructionText);

    // Afegir estils al clock container
    clockContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
    clockContainer.style.cursor = 'pointer';
    clockContainer.style.padding = '20px';
    clockContainer.style.borderRadius = '8px';
    clockContainer.style.transition = 'background-color 0.2s ease';

    clockContainer.addEventListener('mouseover', () => {
        clockContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
    });

    clockContainer.addEventListener('mouseout', () => {
        clockContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
    });

    // In the initialization section, modify summary container texts
    const summaryContainer = document.getElementById('summary-container');
    const summaryLabels = [
        { icon: workIcon, text: 'Treball' },
        { icon: restIcon, text: 'Descans' },
        { icon: totalIcon, text: 'Total' }
    ];
    
    summaryLabels.forEach((label, index) => {
        const span = summaryContainer.querySelector(`.summary-item:nth-child(${index + 1}) span`);
        span.innerHTML = `${label.icon} ${label.text}`;
        span.style.display = 'flex';
        span.style.alignItems = 'center';
        span.style.gap = '5px';
    });

    // Clock container styles
    clockContainer.style.backgroundColor = '#2E7D32';
    clockContainer.style.display = 'flex';
    clockContainer.style.flexDirection = 'column';
    clockContainer.style.alignItems = 'center';
    clockContainer.style.justifyContent = 'center';
    clockContainer.style.padding = '20px';
    clockContainer.style.borderRadius = '8px';
    clockContainer.style.cursor = 'pointer';
    clockContainer.style.transition = 'background-color 0.2s ease';
    clockContainer.style.maxWidth = '100%';  // Add max-width
    clockContainer.style.width = '100%';     // Add width
    clockContainer.style.boxSizing = 'border-box'; // Ensure padding is included in width

    // === PWA inline: dynamic manifest and service worker registration ===
    try {
        // 1) Build manifest dynamically (single-file app)
        const manifest = {
            name: 'Windsurf TIMER',
            short_name: 'TIMER',
            start_url: './',
            scope: './',
            display: 'standalone',
            background_color: getComputedStyle(document.documentElement).getPropertyValue('--bg-color')?.trim() || '#1a1a1a',
            theme_color: getComputedStyle(document.documentElement).getPropertyValue('--accent-color')?.trim() || '#00aaff',
            icons: [
                {
                    src: 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IiNmMGYwZjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEyIDdWMTJIMTdNMjEgMTJDMjEgMTYuOTcwNiAxNi45NzA2IDIxIDEyIDIxQzcuMDI5NDQgMjEgMyAxNi45NzA2IDMgMTJDMyA3LjAyOTQ0IDcuMDI5NDQgMyAxMiAzQzE2Ljk3MDYgMyAyMSA3LjAyOTQ0IDIxIDEyWiIgc3Ryb2tlPSIjZjBmMGYwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvc3ZnPg==',
                    sizes: '192x192',
                    type: 'image/svg+xml'
                },
                {
                    src: 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IiNmMGYwZjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEyIDdWMTJIMTdNMjEgMTJDMjEgMTYuOTcwNiAxNi45NzA2IDIxIDEyIDIxQzcuMDI5NDQgMjEgMyAxNi45NzA2IDMgMTJDMyA3LjAyOTQ0IDcuMDI5NDQgMyAxMiAzQzE2Ljk3MDYgMyAyMSA3LjAyOTQ0IDIxIDEyWiIgc3Ryb2tlPSIjZjBmMGYwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvc3ZnPg==',
                    sizes: '512x512',
                    type: 'image/svg+xml'
                }
            ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        let manifestLink = document.querySelector('link[rel="manifest"]');
        if (!manifestLink) {
            manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            document.head.appendChild(manifestLink);
        }
        manifestLink.href = manifestUrl;

        // 2) Register a Service Worker from a Blob URL
        if ('serviceWorker' in navigator) {
            const swCode = `const CACHE='timer-cache-v1';\nconst PRECACHE=['./','index.html'];\nself.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(PRECACHE)));self.skipWaiting();});\nself.addEventListener('activate',e=>{e.waitUntil(self.clients.claim());});\nself.addEventListener('fetch',e=>{const r=e.request;if(r.method!=='GET'){return;}e.respondWith(caches.match(r).then(res=>res||fetch(r).then(resp=>{const copy=resp.clone();caches.open(CACHE).then(c=>c.put(r,copy));return resp;}).catch(()=>{if(r.mode==='navigate'){return caches.match('index.html');}})));});`;
            const swBlob = new Blob([swCode], { type: 'text/javascript' });
            const swUrl = URL.createObjectURL(swBlob);
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl, { scope: './' }).catch(() => {});
            });
        }
    } catch (e) {
        // Silenciar errores PWA para no romper la app principal
        try { console.warn('PWA inline setup failed', e); } catch {}
    }
    // === End PWA inline ===
});

	</script>
</body>
</html>